<%= content_for :head_title, @strip.title %>
<%= content_for :favicon, @strip.strip_collection.icon_url %>

<div id="middle-container" class="box">
  <div id="search">
    <%= form_tag(search_strip_collection_strips_path, 
          {:method => :get, :enforce_utf8 => false}) do %>
      <%= text_field_tag :text, params[:text] %>
      <%= submit_tag 'Buscar', {:name => nil} %>
    <% end %>
  </div>
  
  <div id="user-info">
    <% if user_signed_in? %>
      <%= current_user.name %> [<%= link_to "Salir", signout_path %>]
    <% else %>
      <%= link_to "Entrar ".html_safe + image_tag("facebook.png", :size => "32"), signin_path %>
    <% end %>
  </div>
  
  <div id="ctitle">
    <%= @strip.title %>
    (<%= @pagination.index + 1 %> de <%= @pagination.total %>)
  </div>
  
  <ul class="comic-nav">
    <li><%= link_to "|<", strip_path(@pagination.first), :accesskey => "f" %></li>
    <li><%= link_to "< Anterior", strip_path(@pagination.previous), :accesskey => "p" %></li>
    <li><%= link_to "Aleatorio", random_path_for_collection_strip(@strip), :accesskey => "r" %></li>
    <li><%= link_to "Siguiente >", strip_path(@pagination.next), :accesskey => "n" %></li>
    <li><%= link_to ">|", strip_path(@pagination.last), :accesskey => "l" %></li>
  </ul>
  
  <div id="comic">
    <%= image_tag @strip.image.url, :width => "800", :height => "228" %>
  </div>
  
  <div id="transcript" class="<%= current_user ? 'editable' : '' %>">
    <div class="toggle-edit">
      <%= content_tag(:pre, @strip.text, class: "text") %>
     
      <% if user_signed_in? %>
        <%= link_to "Editar", "#", :accesskey => "e", :"data-toggle" => ".toggle-edit" %>
      <% else %>
        <%= link_to "Entrar para editar", signin_path %>
      <% end %>
      <%= link_to_history(@strip) %>
    </div>

    <% if user_signed_in? %>
      <%= form_for @strip.transcripts.new(:text => @strip.text), 
            :url => polymorphic_path([@strip.strip_collection, @strip, :transcripts]),
            :html => {:class => "toggle-edit", :style => "display: none"} do |form|%>
        <%= form.text_area :text %>
        <%= form.submit "Guardar" %>
        
        <%= link_to "Cancelar", "#", :accesskey => "c", :"data-toggle" => ".toggle-edit" %>
        <%= link_to_history(@strip) %>
      <% end %>
    <% end %>

    <% if @strip.transcripts.count > 0 %>
      <div id="history">
        <div id="transcript-history" style="display: none">
          <ul>
            <% @strip.transcripts.joins(:user).by_version(:asc).
                 map.with_index.reverse_each do |transcript, idx| %>
              <li>
                <%= idx + 1 %>.
                <%= transcript.user.name %> -
                <%= transcript.created_at.utc.strftime("%d/%m/%Y %H:%M UTC") %>
                -
                <%= link_to "texto", "javascript:void()", 
                      :"data-toggle" => "#transcript-#{transcript.id}" %>
                <%= content_tag(:pre, transcript.text, 
                      :id => "transcript-#{transcript.id}", 
                      :style => "display:none") %>   
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>
  </div>

  <div id="footer">
    <span class="info">
      Tiras transcritas:
      <%= @strip.strip_collection.strips.as do |strips| %>
        <%= strips.with_transcriptions.count %>/<%= strips.count %> 
      <% end %>
    </span>
    
    <%= @strip.strip_collection.footer.maybe.html_safe.value %>
  </div>
</div>
